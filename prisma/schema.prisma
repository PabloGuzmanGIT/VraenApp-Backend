// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & ORGANIZATION MODELS
// ============================================

enum Role {
  ADMIN
  OPERATOR
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String?
  phone     String?
  role      Role     @default(OPERATOR)
  
  // Geolocation
  latitude  Float?
  longitude Float?
  address   String?
  
  // Push Notifications
  pushToken String?
  
  // Preferences
  language  String   @default("es") // 'es' | 'en'
  theme     String   @default("light") // 'light' | 'dark'
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  createdOrganizations Organization[]        @relation("OrganizationCreator")
  memberships          OrganizationMember[]
  transactions         Transaction[]
  providers            Provider[]
  expenseCategories    ExpenseCategory[]
  productServices      ProductService[]
  
  @@index([email])
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  createdById String
  createdBy   User     @relation("OrganizationCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members      OrganizationMember[]
  transactions Transaction[]
  providers    Provider[]
  
  @@index([createdById])
}

model OrganizationMember {
  id             String   @id @default(uuid())
  role           Role     @default(OPERATOR)
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  joinedAt       DateTime @default(now())
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================
// PROVIDER MODEL
// ============================================

model Provider {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  address     String?
  notes       String?
  
  // Owner (can be user or organization)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  transactions Transaction[]
  
  @@index([userId])
  @@index([organizationId])
}

// ============================================
// TRANSACTION MODELS
// ============================================

enum TransactionStatus {
  ACTIVE
  CLOSED
}

model Transaction {
  id              String            @id @default(uuid())
  contractNumber  String            @unique // YYYYMMDD-UUID format
  description     String?
  status          TransactionStatus @default(ACTIVE)
  
  // Product/Service
  productServiceId String?
  productService   ProductService?  @relation(fields: [productServiceId], references: [id], onDelete: SetNull)
  
  // Quantities and pricing
  quantity        Float?            // kg, units, etc.
  unitPrice       Float?
  totalAmount     Float?
  
  // Dates
  transactionDate DateTime          @default(now())
  closedAt        DateTime?
  
  // Signature & Photos
  signatureUrl    String?
  
  // Owner
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId  String?
  organization    Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  providerId      String
  provider        Provider          @relation(fields: [providerId], references: [id], onDelete: Restrict)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  advances        Advance[]
  deliveries      Delivery[]
  expenses        Expense[]
  attachments     Attachment[]
  
  @@index([userId])
  @@index([organizationId])
  @@index([providerId])
  @@index([contractNumber])
  @@index([status])
}

// ============================================
// ADVANCE (Adelanto) MODEL
// ============================================

model Advance {
  id             String      @id @default(uuid())
  amount         Float
  description    String?
  advanceDate    DateTime    @default(now())
  
  transactionId  String
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  @@index([transactionId])
}

// ============================================
// DELIVERY (Entrega) MODEL
// ============================================

model Delivery {
  id             String      @id @default(uuid())
  quantity       Float       // kg, units, etc.
  description    String?
  deliveryDate   DateTime    @default(now())
  
  transactionId  String
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  @@index([transactionId])
}

// ============================================
// EXPENSE MODELS
// ============================================

model ExpenseCategory {
  id          String   @id @default(uuid())
  name        String
  nameEn      String?  // English translation
  isDefault   Boolean  @default(false)
  
  // If userId is null, it's a default category
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  // Relations
  expenses    Expense[]
  
  @@index([userId])
}

model Expense {
  id             String           @id @default(uuid())
  amount         Float
  description    String?
  expenseDate    DateTime         @default(now())
  
  categoryId     String
  category       ExpenseCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  
  // Can be associated with a transaction or be general
  transactionId  String?
  transaction    Transaction?     @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  @@index([transactionId])
  @@index([categoryId])
}

// ============================================
// PRODUCT/SERVICE MODEL
// ============================================

model ProductService {
  id          String   @id @default(uuid())
  name        String
  type        String   @default("product") // 'product' | 'service'
  description String?
  
  // Owner
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  // Relations
  transactions Transaction[]
  
  @@index([userId])
}

// ============================================
// ATTACHMENT MODEL (Photos, Documents)
// ============================================

enum AttachmentType {
  PHOTO
  SIGNATURE
  DOCUMENT
}

model Attachment {
  id             String         @id @default(uuid())
  type           AttachmentType @default(PHOTO)
  url            String
  filename       String
  mimeType       String?
  size           Int?           // bytes
  
  transactionId  String
  transaction    Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime       @default(now())
  
  @@index([transactionId])
}

// ============================================
// SYNC LOG (for offline-first sync)
// ============================================

model SyncLog {
  id             String   @id @default(uuid())
  userId         String
  deviceId       String?
  syncType       String   // 'push' | 'pull'
  recordsCount   Int      @default(0)
  status         String   // 'success' | 'failed'
  errorMessage   String?
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// ANALYTICS DATA (Anonymous aggregated data)
// ============================================

model AnalyticsData {
  id             String   @id @default(uuid())
  region         String?  // e.g., "Vraem", "San Martin"
  productType    String?
  
  // Aggregated data (no personal info)
  totalVolume    Float?   // kg
  averagePrice   Float?
  transactionCount Int?
  
  periodStart    DateTime
  periodEnd      DateTime
  
  createdAt      DateTime @default(now())
  
  @@index([region])
  @@index([periodStart])
}
