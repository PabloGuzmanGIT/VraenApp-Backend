// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  OPERATOR
}

enum OperationStatus {
  OPEN       // En curso
  CLOSED     // Finalizada
}

enum MoneyMovementType {
  ADVANCE    // Adelanto
  PAYMENT    // Pago
  ADJUSTMENT // Ajuste
  DISCOUNT   // Descuento
}

enum ProductMovementType {
  DELIVERY   // Entrega
  ADJUSTMENT // Ajuste
  LOSS       // Merma
}

enum PaymentMethod {
  CASH       // Efectivo
  TRANSFER   // Transferencia
}

enum SaleStatus {
  PENDING    // Pendiente de pago
  PARTIAL    // Pago parcial
  COMPLETED  // Pagado
}

enum ExpenseScope {
  BUSINESS   // Gasto de negocio
  PERSONAL   // Gasto personal
}

enum ExpenseType {
  FREIGHT    // Flete
  TRANSPORT  // Transporte
  FOOD       // Alimentación
  OTHER      // Otros
}

enum IncomeScope {
  BUSINESS   // Ingreso de negocio
  PERSONAL   // Ingreso personal
}

// ============================================
// USER & ORGANIZATION MODELS
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String?
  phone     String?
  role      Role     @default(OPERATOR)
  
  // Preferences
  language  String   @default("es")
  theme     String   @default("light")
  
  // Push Notifications
  pushToken String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  organizations   OrganizationMember[]
  operations      Operation[]
  sales           Sale[]
  expenses        Expense[]
  incomes         Income[]
  providers       Provider[]
  clients         Client[]
  products        Product[]
  
  @@index([email])
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     OrganizationMember[]
}

model OrganizationMember {
  id             String   @id @default(uuid())
  role           Role     @default(OPERATOR)
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  joinedAt       DateTime @default(now())
  
  @@unique([userId, organizationId])
}

// ============================================
// PRODUCT MODEL (Cacao, Coffee, etc.)
// ============================================

model Product {
  id          String   @id @default(uuid())
  name        String   // "Cacao", "Café", etc.
  unit        String   @default("kg") // kg, unidades, etc.
  description String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  operations  Operation[]
  sales       Sale[]
  
  @@index([userId])
}

// ============================================
// PROVIDER MODEL (Productores/Proveedores)
// ============================================

model Provider {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  address     String?
  notes       String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  operations  Operation[]
  
  @@index([userId])
}

// ============================================
// CLIENT MODEL (Compradores)
// ============================================

model Client {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  address     String?
  notes       String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  sales       Sale[]
  
  @@index([userId])
}

// ============================================
// OPERATION MODEL (Operación de Compra)
// ============================================

model Operation {
  id              String           @id @default(uuid())
  operationNumber String           @unique
  status          OperationStatus  @default(OPEN)
  
  // Product and pricing
  productId       String
  product         Product          @relation(fields: [productId], references: [id], onDelete: Restrict)
  pricePerUnit    Float            // Precio acordado por kg/unidad
  agreedQuantity  Float?           // Cantidad acordada (opcional)
  
  // Provider
  providerId      String
  provider        Provider         @relation(fields: [providerId], references: [id], onDelete: Restrict)
  
  // Owner
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dates
  operationDate   DateTime         @default(now())
  closedAt        DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  moneyMovements    MoneyMovement[]
  productMovements  ProductMovement[]
  expenses          Expense[]
  
  @@index([userId])
  @@index([providerId])
  @@index([productId])
  @@index([status])
}

// ============================================
// MONEY MOVEMENT (Adelantos, Pagos, Ajustes)
// ============================================

model MoneyMovement {
  id             String            @id @default(uuid())
  amount         Float
  movementType   MoneyMovementType
  paymentMethod  PaymentMethod     @default(CASH)
  description    String
  movementDate   DateTime          @default(now())
  
  operationId    String
  operation      Operation         @relation(fields: [operationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  
  @@index([operationId])
  @@index([movementDate])
}

// ============================================
// PRODUCT MOVEMENT (Entregas, Ajustes, Mermas)
// ============================================

model ProductMovement {
  id             String               @id @default(uuid())
  netWeight      Float                // Peso neto (el que cuenta)
  grossWeight    Float?               // Peso bruto
  tare           Float?               // Tara
  movementType   ProductMovementType
  description    String
  movementDate   DateTime             @default(now())
  
  operationId    String
  operation      Operation            @relation(fields: [operationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  
  @@index([operationId])
  @@index([movementDate])
}

// ============================================
// SALE MODEL (Ventas)
// ============================================

model Sale {
  id              String     @id @default(uuid())
  saleNumber      String     @unique
  status          SaleStatus @default(PENDING)
  
  // Product and quantity
  productId       String
  product         Product    @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity        Float      // Cantidad vendida
  pricePerUnit    Float      // Precio de venta
  totalAmount     Float      // quantity * pricePerUnit
  
  // Client
  clientId        String
  client          Client     @relation(fields: [clientId], references: [id], onDelete: Restrict)
  
  // Owner
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  saleDate        DateTime   @default(now())
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Relations
  payments        SalePayment[]
  
  @@index([userId])
  @@index([clientId])
  @@index([productId])
  @@index([status])
}

// ============================================
// SALE PAYMENT (Pagos de Ventas)
// ============================================

model SalePayment {
  id             String        @id @default(uuid())
  amount         Float
  paymentMethod  PaymentMethod
  description    String?
  paymentDate    DateTime      @default(now())
  
  saleId         String
  sale           Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime      @default(now())
  
  @@index([saleId])
}

// ============================================
// EXPENSE (Gastos - Negocio y Personal)
// ============================================

model Expense {
  id             String       @id @default(uuid())
  amount         Float
  expenseType    ExpenseType  @default(OTHER)
  scope          ExpenseScope @default(BUSINESS)
  description    String
  expenseDate    DateTime     @default(now())
  
  // Optional: linked to operation
  operationId    String?
  operation      Operation?   @relation(fields: [operationId], references: [id], onDelete: SetNull)
  
  // Owner
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([userId])
  @@index([operationId])
  @@index([scope])
  @@index([expenseDate])
}

// ============================================
// INCOME (Ingresos Personales - no ventas)
// ============================================

model Income {
  id            String      @id @default(uuid())
  amount        Float
  scope         IncomeScope @default(PERSONAL)
  description   String
  incomeDate    DateTime    @default(now())
  
  // Owner
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([userId])
  @@index([scope])
  @@index([incomeDate])
}

// ============================================
// SYNC LOG (for offline-first sync)
// ============================================

model SyncLog {
  id             String   @id @default(uuid())
  userId         String
  deviceId       String?
  syncType       String   // 'push' | 'pull'
  recordsCount   Int      @default(0)
  status         String   // 'success' | 'failed'
  errorMessage   String?
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}
